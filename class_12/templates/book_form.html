{% extends "base.html" %}

{% block title %}
{% if book %}Edit Book: {{ book.title }}{% else %}Add New Book{% endif %}
{% endblock %}

{% block content %}
<section class="book-form">
    <h2>{% if book %}Edit Book{% else %}Add New Book{% endif %}</h2>
    
    <form id="book-form" action="{{ url_for('create_book_page') if not book else url_for('update_book_page', book_id=book.id) }}" method="post">
        <div class="form-group">
            <label for="title">Title:</label>
            <input type="text" id="title" name="title" value="{{ book.title if book else '' }}" required>
        </div>
        
        <div class="form-group">
            <label for="author">Author:</label>
            <input type="text" id="author" name="author" value="{{ book.author if book else '' }}" required>
        </div>
        
        <div class="form-group">
            <label for="price">Price:</label>
            <input type="number" id="price" name="price" step="0.01" min="0" value="{{ book.price if book else '' }}" required>
        </div>
        
        <div class="form-actions">
            <a href="{{ url_for('list_books_page') }}" class="btn">Cancel</a>
            <button type="submit" class="btn primary">
                {% if book %}Save Changes{% else %}Add Book{% endif %}
            </button>
        </div>
    </form>
</section>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('book-form').addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Get token
        const token = document.getElementById('token-input').value;
        
        if (!token) {
            alert('Please enter your authentication token first');
            return;
        }
        
        // Get form data
        const title = document.getElementById('title').value;
        const author = document.getElementById('author').value;
        const price = parseFloat(document.getElementById('price').value);
        
        // Create book object
        const bookData = { title, author, price };
        
        // Determine if we're creating or updating
        {% if book %}
        const url = '/books/{{ book.id }}';
        const method = 'PUT';
        {% else %}
        const url = '/books/';
        const method = 'POST';
        {% endif %}
        
        // Send request
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(bookData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to save book');
            }
            return response.json();
        })
        .then(book => {
            alert('Book saved successfully');
            // Redirect to book list
            window.location.href = '{{ url_for("list_books_page") }}';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving book: ' + error.message);
        });
    });
</script>
{% endblock %}
